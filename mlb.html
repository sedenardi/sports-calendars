<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>Sane MLB Calendar</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
    <script src="http://momentjs.com/downloads/moment-timezone-with-data-2010-2020.min.js"></script>
    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <style>
body {
  font-family: 'Open Sans', sans-serif;
}
table {
  width: 100%;
}
td {
  padding: 10px;
}
#calendar table tbody tr td {
  vertical-align: top;
}
.month table {
  border-collapse: collapse;
}
.month td, th {
  border: 1px solid #999;
  padding: 0;
}
/*.month td {
  position: relative;
  height: 3em;
}*/
.monthTitle {
  text-align: center;
}
#header {
  text-align: center;
}
.day {
  float: left;
}
.time {
  float: right;
}
.topRow {
  font-size: .75em;
  padding: 0 .25em;
}
.bottomRow {
  font-size: 1em;
  clear: left;
  text-align: center;
  margin-top: .25em;
}
.home {
  background-color: #98bce9;
}
.away {
  background-color: #d6e4f6;
}
    </style>
  </head>
  <body>
    <div id="header">Downloading Schedule Info...<span id="done">0</span>/30</div>
    <div id="calendar">
      <table>
        <tbody>
          <tr>
            <td>
              <div class="month" data-month="04">
                <div class="monthTitle">April</div>
                <table>
                  <thead>
                    <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
                  </thead>
                  <tbody>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </td>
            <td>
              <div class="month" data-month="05">
                <div class="monthTitle">May</div>
                <table>
                  <thead>
                    <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
                  </thead>
                  <tbody>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </td>
            <td>
              <div class="month" data-month="06">
                <div class="monthTitle">June</div>
                <table>
                  <thead>
                    <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
                  </thead>
                  <tbody>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="month" data-month="07">
                <div class="monthTitle">July</div>
                <table>
                  <thead>
                    <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
                  </thead>
                  <tbody>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </td>
            <td>
              <div class="month" data-month="08">
                <div class="monthTitle">August</div>
                <table>
                  <thead>
                    <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
                  </thead>
                  <tbody>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </td>
            <td>
              <div class="month" data-month="09">
                <div class="monthTitle">September</div>
                <table>
                  <thead>
                    <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
                  </thead>
                  <tbody>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div>
      <span class="home">Home Games</span>
      &nbsp;&nbsp;
      <span class="away">Away Games</span>
      &nbsp;&nbsp;&nbsp;&nbsp;
      <select id="teamSelect" style="display:none;width:15em;">
      </select>
    </div>
    <script>
var teamGames = { },
    year = 2015,
    dateFormat = 'YYYY-MM-DD';

var updateProgress = function() {
  var done = Object.keys(teamGames).length;
  if (done < 30) {
    $('#done').text(done);
  } else {
    $('#header').html('Choose a team below to see their schedule...');
    var options = Object.keys(teamGames)
      .sort(function(a,b) {
        return (teamGames[a].city + ' ' + teamGames[a].name).toLocaleLowerCase() >
          (teamGames[b].city + ' ' + teamGames[b].name).toLocaleLowerCase() ? 1 : -1;
      }).map(function(v,i) {
        return '<option value="' + v + '">' +
          teamGames[v].city + ' ' + teamGames[v].name +
          '</option>';
      }).join('');
    $('#teamSelect').html(options);
    $('#teamSelect').show();
    $('#teamSelect').select2()
  }
};

var getSchedule = function(teamId, cb) {
  console.log('Fetching: ' + teamId);
  $.ajax({
    url: 'http://www.mlb.com/lookup/json/named.schedule_team_sponsors.bam?',
    type: 'GET',
    dataType: 'JSON',    
    data: {
      start_date: '\'2015/04/01\'',
      end_date: '\'2015/10/31\'',
      season: 2015,
      game_type: '\'R\'',
      team_id: teamId
    },
    success: function(response) {
      cb(teamId, response.schedule_team_sponsors.schedule_team_complete.queryResults.row);
    }
  });
};

var addGames = function(teamId, cb) {
  if (!teamGames[teamId]) {
    getSchedule(teamId, function(teamId, rows) {
      teamGames[teamId] = {
        abbrev: rows[0].team_abbrev,
        name: rows[0].team_brief,
        city: rows[0].team_city
      };

      teamGames[teamId].games = rows.map(function(v,i) {
        return {
          time: moment.tz(v.game_time_et, "America/New_York").toISOString(),
          opponent_id: v.opponent_id,
          home: (v.home_away_sw === 'H' ? 'home' : 'away')
        };
      });
      console.log('Done fetching: ' + teamId);
      updateProgress();
      cb();
    });
  }    
};

var getUnprocessed = function() {
  var teams = [];
  for (var teamId in teamGames) {
    teams = teams.concat(teamGames[teamId].games.map(function(v,i) {
      return v.opponent_id;
    }));
  }
  teams = teams.filter(function(v,i) {
    return !teamGames[v];
  });
  return new Set(teams);
};

var processTeamSet = function(teamSet) {
  var total = teamSet.size,
      done = 0;
  if (total) {
    teamSet.forEach(function(v) {
      addGames(v, function() {
        done++;
        if (total === done) {
          processTeamSet(getUnprocessed());
        }
      });
    });
  } else {
    console.log('done');
    updateProgress();
  }  
};

var buildCell = function($cell,date) {
  $cell.addClass('date');
  $cell.attr('data-date', date.format(dateFormat));
  var inner = '<div class="topRow">' +
    '<div class="day">' + date.date() + '</div>' +
    '<div class="time"></div></div>' +
    '<div class="bottomRow"><div class="opponent"></div></div>';
  $cell.html(inner);
};

var buildCalendar = function() {
  $('.month').each(function() {
    var month = $(this).attr('data-month');
    var date = moment(year.toString() + '-' + month + '-01');
    var weekOffset = date.day();
    var monthIndex = date.month();
    while (date.month() === monthIndex) {
      var dayOfWeek = date.day();
      var week = Math.ceil((date.date() + weekOffset) / 7) - 1;
      buildCell($(this).find('tbody:first').find('tr').eq(week).find('td').eq(dayOfWeek), date);
      date.add(1,'d');
    }
    if (month === '09') {
      weekOffset += 30;
      while (Math.ceil((date.date() + weekOffset) / 7) < 7) {
        var dayOfWeek = date.day();
        var week = Math.ceil((date.date() + weekOffset) / 7) - 1;
        buildCell($(this).find('tbody:first').find('tr').eq(week).find('td').eq(dayOfWeek), date);
        date.add(1,'d');
      }
    }
    var lastWeek = $(this).find('tr:last').find('td').filter(function() {
      return $(this).hasClass('date');
    }).length;
    if (!lastWeek) {
      $(this).find('tr:last').remove();
    }
  });
};

var fillCalendar = function(teamId) {
  if (!teamGames[teamId])
    return;

  $('.date').each(function() {
    $(this).removeClass('home');
    $(this).removeClass('away');
    $(this).removeClass('hide');
    $(this).find('.time:first').html();
    $(this).find('.opponent:first').html();
  });

  $('#header').html(teamGames[teamId].city + ' ' + teamGames[teamId].name + ' ' + year + ' Schedule');

  teamGames[teamId].games.forEach(function(v,i) {
    var date = moment(v.time);
    $cell = $('.date[data-date="' + date.format(dateFormat) + '"]');
    $cell.addClass(v.home);
    $cell.find('.time:first').html(date.format('h:mm'));
    $cell.find('.opponent:first').html(teamGames[v.opponent_id].abbrev);
  });
};

$('#teamSelect').change(function() {
  fillCalendar($(this).val());
});

processTeamSet(new Set(['147']));
buildCalendar();
    </script>
  </body>
</html>